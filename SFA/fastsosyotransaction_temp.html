<!DOCTYPE html>
<html>
<head>
  <title>
     Fastsosyo Transaction - Temp
  </title>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <meta name="description" content="">
  <meta name="author" content="">
 <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.7.0/css/all.css">
 <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">
 <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
 <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>
 
 <link rel="shortcut icon" href="/img/mdlogo_web.png" type="image/png"/>
 <link rel="stylesheet" href="/css/mdDesign.css"/>

  <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.10.19/css/dataTables.bootstrap.min.css">
  <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/buttons/1.5.6/css/buttons.dataTables.min.css">
  <link rel="stylesheet" href="/js/bootstrap-multiselect-master/dist/css/bootstrap-multiselect.css" type="text/css"/>

  <style>
    @media (min-width: 768px) {
      .modal-xl {
        width: 90%;
      max-width:1200px;
      }
    }

    .overModal{
      overflow-y:inherit !important;;
    }

    .font-weight-bold{
      font-weight: bold;
    }
  </style>
</head>
<body onload="init()">
  <div id="mySidenav" class="sidenav">
  <div class='image'><img alt='mdbuddylogo' class='logoMd' src='/img/mdbuddylogo_jeff.png'/></div>
    <a href="https://mybuddy-sfa.com/SFA/Dashboard"> <span class='glyphicon glyphicon-home'></span> Dashboard</a>
    <a href="https://mybuddy-sfa.com/SFA/digitalMapping"> <span class='glyphicon glyphicon-map-marker'></span> Digital Mapping</a>
    <a href="https://mybuddy-sfa.com/SFA/customerMapping"> <span class="fa fa-users" aria-hidden="true"></span> Customer Mapping</a>
    <a href="territoryGeofencing"> <span class='glyphicon glyphicon-cog'></span> Territory Geofencing</a>
   <a data-toggle="collapse" href="#collapse1" id='navDrop'> <span class='glyphicon glyphicon-duplicate' id='changeIcon'></span> Reports
    <i class="glyphicon glyphicon-menu-down pull-right"></i> </a>
      <div id="collapse1" class="panel-collapse collapse" style="margin-left: 17px; font-size: 5px !important">
        <a href="salesReport"> Sales Report</a>
        <a href="fastsosyotransaction"> Fastsosyo Transaction</a>
        <a href="transactionLedger"> Transaction Ledger</a>
        <a href="UnprocessedOrders"> Unprocessed Orders</a>
        <a href="dsr"> DSR</a>
        <a href="dcr"> Daily Collection</a>
        <a href="stockRequest"> Stock Request</a>
        <a href="unuploaded"> Unuploaded</a>
        <a href="BOReport"> BO</a>
        <a href="Stocktake Report"> Stocktake</a>
        <a href="inventory"> Inventory Valuation</a>
        <a href="jobberMaintenance"> Jobber</a>
        <a href="syncreport">Sync Report</a>
        <a href="soaprvreport">SO Approval</a>
      </div>
   <a data-toggle="collapse" href="#collapse2" id='navDrop' class="maintenanceCont"> <span class="fa fa-cogs" aria-hidden="true" id='changeIcon'></span> Maintenance
    <i class="glyphicon glyphicon-menu-down pull-right"></i> </a>
      <div id="collapse2" class="panel-collapse collapse" style="margin-left: 17px; font-size: 9px !important">
        <a href="dataMaintenance"> Data</a>
        <a href="customer"> Customer</a>
        <a href="cmf">CMF</a>
        <a href="geoReset"> Georeset</a>
        <a href="salesman"> Salesman</a>
        <a href="product"> Product</a>
        <a href="customerTagging"> Tagging</a>
        <a href="bankmaintenance"> Bank</a>
        <a href="mcpcalibration">MCP Calibration</a>
      </div>
  <!-- <a href="Alert"> <span class='glyphicon glyphicon-envelope'></span> Alert Messages</a> -->
  <hr />
        <a href="https://mybuddy-sfa.com/SFA/v2/dashboard">Switch to New Dashboard</a>
  <hr>
  <a href="fastsosyotranscation" class='activeYes'><span class='glyphicon glyphicon-duplicate'></span> Fastsosyo Transaction</a>
   <!--<div class='hideNav'>
      <a href="#" class="btn btn-primary btn-nav" onclick='closeNav()'>
          <span class='glyphicon glyphicon-menu-left' style='color:white;'></span>
      </a>
    </div>-->
  </div>
  <div id="main">
  <h4 class="display-4 dispMargin">
          <a href="#" id='navBtn' class="btn btn-primary"  style='margin-right: 15px; outline: none;'>
            <span class="glyphicon glyphicon-menu-hamburger"></span> 
          </a>
          <span onclick='closeNav()'>
            <i class="fas fa-clipboard-list"></i> Fastsosyo Transaction
            <!--<span class='pull-right' >
                  <img src="img/colpal.png" alt="nutriasia" style="float:right;">
            </span>-->
              <span class="nav navbar-nav navbar-right">
                <li class="dropdown">
                  <a style='float:right;' href="#" class="dropdown-toggle" data-toggle="dropdown" id='dropThisDown'>
                      <span class="label label-pill label-danger count" style='border-radius: 10px; font-size: 10px;'></span>
                      <span class="fa fa-bell"></span>
                  </a>
                  <ul class="dropdown-menu dropdown-pill">
                    <div id="notificationElement" class="scroll" data-simplebar>
                        <div id='notifs-icon-div'></div>
                    </div>
                    <a type="button" class="btn btn-default btn-block" href='Alert' id='seeAll' >See all</a>
                  </ul>
                </li>
                <li class="dropdown">
                  <a class="dropdown-toggle" data-toggle="dropdown" href="#">
                    <i class="fas fa-user"></i>
                  </a>
                  <ul class="dropdown-menu dropdown-user">
                      <li><a href="Profile.html"><i class="fas fa-user"></i> My Account</a>
                      </li>
                      <li class="divider"></li>
                      <li><a href="#" id="admin-logout-btn"><i class="fas fa-sign-out-alt"></i> Logout</a>
                      </li>
                  </ul>
                </li>
              </span>
            </span>
          </h4>

         <div class="panel cust-panel">
               <div class="panel-heading">
                   <i class="fas fa-clipboard-list"></i> <span id="titleHeading"></span>
               </div>
                <div class="panel-body" style='background-color:#fff; color: black;'>   
                  <div class="table-responsive">
                    <table class="table table-hover display nowrap customerList" style="width: 100%;">
                       <thead>
                        <tr>
                          <th>TRANSDATE</th>
                          <th>STORE NAME</th>
                          <th class=""># SKU</th>
                          <th class="">AMOUNT</th>
                          <th>SALESMAN</th>
                          <th>STATUS</th>
                        </tr>
                      </thead>
                      <tbody>
                      </tbody>
                    </table>
                  </div>
               </div>
         </div><!--main panel end-->

         <div class="modal fade" id="tojobbermodal" role="dialog">
            <div class="modal-dialog modal-xl">
              <!-- Modal content-->
              <div class="modal-content" style="overflow:hidden;">
                <div class="modal-header">
                  <button type="button" class="close" data-dismiss="modal">&times;</button>
                  <h4 class="modal-title">Customer Details</h4>
                </div>
                <div class="modal-body overModal">
                    <div>
                        <div style="float: left; width: 50%;">
                          <div class="validateGroup">
                            <h5><legend>Validate</legend></h5>
                            <table class="table table-hover">
                              <tr>
                                <td>Salesman:</td>
                                <td id="">
                                   <select id="salesmanList" class="form-control">
                                      <option value="" disabled selected hidden>Select salesman</option>
                                    </select> 
                                    <!-- <input type="text" name="" id="salesman_aio" class="job-inpt-data-h"> -->
                               </td>
                              </tr>
                              <tr>
                                <td>Customer Code:</td>
                                <td id="">
                                   <select id="customerListSelect" class="form-control">
                                      <option value="" disabled selected hidden>Select customer code</option>
                                    </select> 
                                    <!-- <input type="text" name="" id="salesman_aio" class="job-inpt-data-h"> -->
                               </td>
                              </tr>
                            </table>
                          </div>
                         
                            <H5><legend>Details</legend></H5>
                            <table class="table table-hover">
                              <tr>
                                <td>Reference No:</td>
                                <td><input type="text" name="" id="refNo_aio" class="job-inpt-data-h form-control font-weight-bold"></td>
                              </tr>
                              <tr>
                                <td># SKU:</td>
                                <td><input type="text" name="" id="sku_aio" class="job-inpt-data-h form-control font-weight-bold"></td>
                              </tr>
                              <tr>
                                <td>Amount:</td>
                                <td><input type="text" name="" id="amount_aio" class="job-inpt-data-h form-control font-weight-bold"></td>
                              </tr>
                                <tr>
                                  <td>Store:</td>
                                  <td><input type="text" name="" id="storename_aio" class="job-inpt-data-h form-control font-weight-bold"></td>
                                </tr>
                                <tr>
                                  <td>Owner:</td>
                                  <td id=""><input type="text" name="" id="owner_aio" class="job-inpt-data-h form-control font-weight-bold"></td>
                                </tr>
                                <tr>
                                    <td>Contact #:</td>
                                    <td>
                                        <input type="text" id="storecontno_aio" class="job-inpt-data-h form-control font-weight-bold">
                                    </td>
                                </tr>
                                <tr>
                                  <td>Address:</td>
                                  <td><input type="text" name="" id="address_aio" class="job-inpt-data-h form-control font-weight-bold"></td>
                                </tr>
                                <tr>
                                    <td>Latlng:</td>
                                    <td ><input type="text" name="" id="latlng_aio" class="job-inpt-data-h form-control font-weight-bold"></td>
                                </tr>
                                <tr>
                                  <td>CustCode:</td>
                                  <td id=""><input type="text" name="" id="customerCode_aio" class="job-inpt-data-h form-control font-weight-bold"></td>
                                </tr>
                                
                              </table>

                              <div class="conf_section">
                                <table class="table table-sm">
                                  <tr>
                                    <td>Salesman Assigned:</td>
                                    <td>
                                      <input type="text" name="" id="salesman_conf" class="job-inpt-data-h form-control font-weight-bold">
                                    </td>
                                  </tr>
                                  <tr>
                                    <td>Customer Code:</td>
                                    <td>
                                      <input type="text" name="" id="customer_conf" class="job-inpt-data-h form-control font-weight-bold">
                                    </td>
                                  </tr>
                                </table>
                              </div>
                        </div>
                        <div style="width: 50%; float: right;" class="pull-right">
                            <div id="map" style="height: 650px;"></div>
                        </div>

                     <input type="hidden" name="" id="storeIDHolder">
                     <input type="hidden" id="salesman_res">
                     <input type="hidden" id="storeID_res">
                     <input type="hidden" id="customer_res">
                     <input type="hidden" id="refno_res">
                    </div>
                </div>

                <div class="modal-footer" style="float: right;">
                  <small class="text-info pull-left infoFooter"></small>
                  <button type="button" class="btn btn-default" data-dismiss="modal">Cancel</button>
                  <button type="button" class="btn btn-primary resendBtn" onclick="resend_transaction()">Resend Transaction</button>
                  <button type="button" class="btn btn-primary validateGroup" id="addJobberBtn" data-dismiss="modal" onclick="exec_asignSalesman()">Verify Transaction (send as draft)</button>
                </div>
              
              </div>
            </div>
          </div>

          <div class="modal fade" id="duplicateUserModal" role="dialog">
            <div class="modal-dialog">
              <div class="modal-content">
                <div class="modal-header">
                  <h4 class="modal-title">SESSION ENDED</h4>
                </div>
                <div class="modal-body">
                  <p>Sorry, your session has been disconnected. Another user is currently using your account.</p>
                </div>
                <div class="modal-footer">
                  <button type="button" class="btn btn-primary" onclick="cofirmationDupUser()">GOT IT</button>
                </div>
              </div>
            </div>
           </div>
  </div><!--#main-->

    <script src="https://maps.googleapis.com/maps/api/js?v=quarterly&key=AIzaSyAt0Pxe9_3DTav3DmUQzHfgd07s_LcJo7I"></script>
    <script type="text/javascript" src="https://cdn.datatables.net/1.10.19/js/jquery.dataTables.min.js"></script>
    <script type="text/javascript" src="https://cdn.datatables.net/1.10.19/js/dataTables.bootstrap.min.js "></script>
    <script type="text/javascript" src="https://cdn.datatables.net/responsive/2.2.3/js/dataTables.responsive.min.js"></script>
    <script src="https://cdn.datatables.net/buttons/1.3.1/js/dataTables.buttons.min.js"></script>
    <script src="https://cdn.datatables.net/buttons/1.3.1/js/buttons.print.min.js"></script>
    <script src="https://cdn.datatables.net/buttons/1.3.1/js/buttons.html5.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.1.3/jszip.min.js"></script>
    <script type="text/javascript" src="/web/web-commons.js"></script>
    <script src="/HASH/md5.js"></script>
    <script src="/HASH/aes.js"></script>
    <script src="/nestle/connectionString/LOCALSTORAGE/storage.js"></script>
    <script type="text/javascript" src="/js/bootbox.min.js"></script>
    <!-- <script type="text/javascript" src="/js/dynamicHeader.js"></script> -->
    <script type="text/javascript" src="/js/bootstrap-multiselect-master/dist/js/bootstrap-multiselect.js"></script>
    <!-- <script src="js/chatApi.js"></script> -->
    <!-- <script type="text/javascript" src="js/duplicate-user.js"></script> -->
    <script>
    var user = localStorage.getItem("adminUserName");
	  var usernm = localStorage.getItem("username");

	//   var s = localStorage.getItem("srvr");
	//   var u = localStorage.getItem("usrnm");
	//   var p = localStorage.getItem("psswrd");
	//   var d = localStorage.getItem("dtbse");
	//   var con_info = [s, p, u, d];

      $('#customerListSelect').html('<option value="">Select a salesman first..</option>');
    getcompname();
    function getcompname(){
      $.ajax ({
          url: "/nestle/connectionString/applicationipAPI.php",
          type: "GET",
          data: {"type":"GET_COMPANYNAME", "CONN":con_info},
          dataType: "json",
          crossDomain: true,
          cache: false,            
            success: function(r){ 
                $('#titleHeading').html(r[0].company.toUpperCase() +' / Fastsosyo Transactions / v.1.0');
            },error: function(jqXHR, textStatus, errorThrown) {
                alert('ERROR CONNECTING TO SERVER:\n Please Check your connection settings.');
            }
        });
    } 

      $('.job-inpt-data-h').attr('disabled', 'disabled');
      showNotif();

      $('#navDrop').click(function() {
        $("i", this).toggleClass("glyphicon-menu-up glyphicon-menu-down");
      });
      
      $(document).on('click', '.dropdown-toggle', function(){
        $('.count').html('');
         showNotif('yes');
      });

    //   setInterval(function(){
    //    //loadPopup();
    //    showNotif();
    //  }, 9000); 

      customerData();
      customerDataTable();

      var sourceData;
      function customerData(){
        $.ajax ({
          url: "/nestle/connectionString/applicationipAPI.php",
          type: "GET",
          data: {"type":"GET_AIO_TRANSACTION", "CONN":con_info},
          dataType: "JSON",
          crossDomain: true,
          cache: false,     
          async: false,       
            success: function(r){ 
              sourceData = r;
            }
        });
      }
      var tableData;
      function customerDataTable(){
         tableData =  $('table.customerList').DataTable({
                    "dom": 'frtip',
                    "data": sourceData,
                    "scrollX": true,
                    "ordering": true,
                    "columns": [
                        { "data": "lastUpdated"},
                        { "data": "STORENAME"},
                        { "data": "TOTALSKU" },
                        { "data": "totalAmount"},
                        { "data": "partnerID" },
                        { "data": "status" }
                    ],
                    "aoColumnDefs": [
                    { 
                      "sClass": "text-right", "aTargets": [ 3 ],
                      // "sClass": "text-center", "aTargets": [ 2 ]  
                    }
                    //You can also set 'sType' to 'numeric' and use the built in css.           
                  ],
                    //buttons: [ 'excel', 'print', 'copy' ],
                    buttons: [
                        {
                            text: 'Sync',
                            className: 'addnewsalesman',
                            action: function(e, dt, node, config){
                                customerData();
                                tableData.clear().rows.add(sourceData).draw();
                            }
                        }
                    ],
                    "language": {
                      "emptyTable": "No available records as of now."
                    },
                    // "aaSorting": [[ 0, "desc" ]],
                    rowCallback: function(row, data, index){
                      var statIndicator = data.status.toString();
                      var salesmanIndi = $(row).find('td:eq(4)').text();
                      var mdCode = data.partnerID.toString();
                      // console.log(salesmanOBj);

                      
                      
                      if(statIndicator == '1'){ 
                        // $(row).find('td:eq(2)').text('BOOKING');
                        $(row).find('td:eq(5)').css({'color': 'white', "background-color": "#e06335", "text-align":"center"});
                        $(row).find('td:eq(5)').text('PENDING');
                      }else{
                        $(row).find('td:eq(5)').text('VERIFIED');
                        $(row).find('td:eq(5)').css({'color': 'white', "background-color": "#00A86B", "text-align":"center"});
                      }

                      if(salesmanIndi == null || salesmanIndi == 'null' || salesmanIndi == ''){
                        $(row).find('td:eq(4)').text('---');
                      }
                      // else{
                      //   var salesmanOBj = getSalesmanDetails(mdCode);
                      //   $(row).find('td:eq(4)').text(mdCode+'_'+salesmanOBj[0].Salesman);
                      // }
                  }
           });

        $('table.customerList tbody').on('click', 'tr', function () {
            var tr = $(this).closest('tr');
            var row = tableData.row(tr);
            exec_savetojobber(row.data());
        });

        function exec_savetojobber(r){
            if(r.status == '1'){
              $('.validateGroup').show();
              $('.conf_section').hide();
              $('.resendBtn').hide();
            }else{

              $('#salesman_res').val(r.partnerID);
              $('#storeID_res').val(r.STOREID);
              $('#customer_res').val(r.custCode);
              $('#refno_res').val(r.refno);

              var salesmanDetails = getSalesmanDetails(r.partnerID);
              $('#salesman_conf').val(salesmanDetails[0].Salesman).show();
              $('#customer_conf').val(displaycustomer(r.custCode)).show();
              $('.validateGroup').hide();
              $('.conf_section').show();
              $('.resendBtn').show();
            }

            showmarker(r.LATITUDE, r.LONGITUDE, r.STORENAME, r.ADDRESS);
            $('#storeIDHolder').val(r.STOREID);
            $('#refNo_aio').val(r.refno);
            $('#storename_aio').val(r.STORENAME.toUpperCase());
            $('#owner_aio').val(r.STOREOWNER);
            $('#address_aio').val(r.ADDRESS);
            $('#sku_aio').val(r.TOTALSKU);
            $('#amount_aio').val(r.totalAmount);
            $('#customerCode_aio').val(displaycustomer(r.custCode));
            $('#salesman_aio').val(r.partnerID);
            $('#storecontno_aio').val(r.STORECONTNO);
            $('#latlng_aio').val(r.LATITUDE+', '+r.LONGITUDE);
            
            if(r.partnerID == null || r.partnerID == 'null'){
                $('#salesman_aio').val('---');
            }

            if(r.custCode == null || r.custCode == 'null'){
                $('#customerCode_aio').val('---');
            }

            $('#tojobbermodal').modal('show');
            
        }
      }

      function displaycustomer(cust){
        if(cust == 'NEW_CUSTOMER'){
          return cust;
        }else{
          return getCustomerName(cust);
        }
      }

      function islockOnverifyer(r){
        
        if(r == 0){
          return '<strong style="color: red;">NO</strong>';
        }
         return '<strong style="color: #5ee663;">YES</strong>';
      }

      function exec_insertCustomer(){
        var r = confirm("Press 'OK' to proceed.");
        if(r){
          $('#addJobberBtn').html('<i class="fa fa-spinner fa-spin"></i> updating.. ');
          $( "#addJobberBtn").prop( "disabled", true );
          var custCode = $('#custCodeH').val();
          $.ajax ({
            url: "/nestle/connectionString/applicationipAPI.php",
            type: "GET",
            data: {
                    "type":"UPDATE_ORDERTYPE", 
                    "CONN":con_info,
                    "custCode":custCode
                  },
            dataType: "JSON",
            crossDomain: true,
            cache: false,     
            async: false,       
              success: function(r){ 
                if(r){
                  customerData();
                  tableData.clear().rows.add(sourceData).draw();
                  alert('Customer succesfully updated!');
                }else{
                  alert('UNABLE TO INSERT: Customer is already in the jobber list!');
                }
                  $("#addJobberBtn").prop( "disabled", false );
                  $('#addJobberBtn').html('Add');
               
              },error: function(XMLHttpRequest, textStatus, errorThrown) {
                alert('ERROR CUSTOMER UPDATE: ' + JSON.stringify(XMLHttpRequest.responseText));
                $( "#addJobberBtn").prop( "disabled", false );
                $('#addJobberBtn').html('Add');
              }
          });
        }
      }

      function exec_insertCustomer_revert(){
        var r = confirm("Press 'OK' to proceed.");
        if(r){
          $('#revertBtn').html('<i class="fa fa-spinner fa-spin"></i> updating.. ');
          $( "#revertBtn").prop( "disabled", true );
          var custCode = $('#custCodeH').val();
          $.ajax ({
            url: "/nestle/connectionString/applicationipAPI.php",
            type: "GET",
            data: {
                    "type":"UPDATE_ORDERTYPE_REVERT", 
                    "CONN":con_info,
                    "custCode":custCode
                  },
            dataType: "JSON",
            crossDomain: true,
            cache: false,     
            async: false,       
              success: function(r){ 
                if(r){
                  customerData();
                  tableData.clear().rows.add(sourceData).draw();
                  alert('Customer succesfully updated!');
                }else{
                  alert('UNABLE TO INSERT: Customer is already in the jobber list!');
                }
                  $("#revertBtn").prop( "disabled", false );
                  $('#revertBtn').html('Add');
               
              },error: function(XMLHttpRequest, textStatus, errorThrown) {
                alert('ERROR CUSTOMER UPDATE: ' + JSON.stringify(XMLHttpRequest.responseText));
                $( "#revertBtn").prop( "disabled", false );
                $('#revertBtn').html('Add');
              }
          });
        }
      }

      function showNotif(view=''){
         $.ajax ({
          url: "../geofencing/GeofencingAPI.php",
          type: "GET",
          data: {"type":"view_notifications_icon_"+user, "view":view},
          dataType: "JSON",
          crossDomain: true,
          cache: false,            
            success: function(response){ 
           // console.log('Notification function has been refresh');                
            $("#notifs-icon-div").html(response.notification);
              if(response.unseen_notification > 0)
              {
               $('.count').html(response.unseen_notification);
              }
            }
        });
      }

    function getToken(mdCode){
        var token = '';
        $.ajax ({
            url: "/nestle/connectionString/applicationipAPI.php",
            type: "GET",
            data: {
                    "type":"GET_USER_TOKEN",
                    "CONN":con_info,
                    "mdCode":mdCode
                },
            dataType: "json",
            crossDomain: true,
            cache: false,
            async: false,         
            success: function(r){
            token = r;
            }
        });
        return token;
    }

    function getSalesmanDetails(mdCode){
        var details = [];
        $.ajax ({
            url: "/nestle/connectionString/applicationipAPI.php",
            type: "GET",
            data: {
                    "type":"GET_AIO_SALESAMAN_DETAILS",
                    "CONN":con_info,
                    "mdCode":mdCode
                },
            dataType: "json",
            crossDomain: true,
            cache: false,
            async: false,         
            success: function(r){
              details = r;
            }
        });
        return details;
    }

    function getCustomerName(custCode){
        var customer = '';
        $.ajax ({
            url: "/nestle/connectionString/applicationipAPI.php",
            type: "GET",
            data: {
                    "type":"GET_MYBUDDY_STORENAME",
                    "CONN":con_info,
                    "custCode":custCode
                },
            dataType: "json",
            crossDomain: true,
            cache: false,
            async: false,         
            success: function(r){
              customer = r[0].custCode+'_'+r[0].custName;
            }
        });
        return customer;
    }

    function getAioStoreToken(storeID){
      var token = '';
        $.ajax ({
            url: "/nestle/connectionString/applicationipAPI.php",
            type: "GET",
            data: {
                    "type":"GET_AIO_TOKEN",
                    "CONN":con_info,
                    "storeID":storeID
                },
            dataType: "json",
            crossDomain: true,
            cache: false,
            async: false,         
            success: function(r){
              token = r;
            }
        });
        return token;
    }
        
    $(window).bind("load", function () {
        $('#work-in-progress').fadeOut();
    });

    function myFunction() {
        var x = document.getElementById("myTopnav");
        if (x.className === "topnav") {
            x.className += " responsive";
        } else {
            x.className = "topnav";
        }
    } 


    (function($) {
      $.fn.clickToggle = function(func1, func2) {
          var funcs = [func1, func2];
          this.data('toggleclicked', 0);
          this.click(function() {
              var data = $(this).data();
              var tc = data.toggleclicked;
              $.proxy(funcs[tc], this)();
              data.toggleclicked = (tc + 1) % 2;
          });
          return this;
      };
    }(jQuery));

     
    $("#navBtn").clickToggle(function() {   
        openNav();
      }, function() {
        closeNav();
    });
      
    function imgError2(image) {
      image.onerror = "";
      image.src = "../img/salesmanPic.jpg";
      return true;
    }  
       
    function openNav() {
        document.getElementById("mySidenav").style.width = "270px";
        document.getElementById("main").style.marginLeft = "270px";
    }

    function closeNav() {
        document.getElementById("mySidenav").style.width = "0";
        document.getElementById("main").style.marginLeft= "0";
    }

    var infoWindow = new google.maps.InfoWindow;
    function showmarker(latval, lngval, storeName, address){
      var contentString = '<p>Storename: <strong>' + storeName.toUpperCase() + '</strong></p>'+
                          'Address: <strong>'+ address+'</strong>';
        var myLatLng = { lat: parseFloat(lngval), lng: parseFloat(latval) };
        var marker = new google.maps.Marker({
            position: myLatLng,
            map,
            infowindow: infoWindow,
            content: contentString,
            title: storeName,
        });
        map.setCenter(marker.getPosition());  
        infoWindow.setContent(contentString);
        infoWindow.open(map, marker);
    }
    
    siteLocation();
    var map, marker, icon;
    function init(){
        // navigator.geolocation.getCurrentPosition(onSuccess, onError, { timeout: 60000 });

        // function onSuccess(position) {

        // var lat = position.coords.latitude;
        // var lng = position.coords.longitude;

        var lat = parseFloat(sitelat);
        var lang = parseFloat(sitelng);

        map = new google.maps.Map(document.getElementById('map'), {
            mapTypeControl: false,
            center: {lat, lang},
            zoom: 15
        });
    //}//onsuccess

    // function onError(error) {
    //         alert('code: ' + error.code + '\n' +
    //             'message: ' + error.message + '\n');
    //     }//onError   
    // google.maps.event.addDomListener(window, 'load', onSuccess);
    }//init  


    allSalesman();
    function allSalesman(){
      $.ajax ({
            url: "/nestle/connectionString/applicationipAPI.php", 
            type: "GET",
            data: {"type":"get_all_salesman_georeset", "CONN":con_info},
            dataType: "html",
            crossDomain: true,
            cache: false,            
            success: function(response){                  
              var data = JSON.parse(response);
              for(var x = 0; x<data.length; x++){
                $('#salesmanList').append('<option value="'+data[x].mdCode+'">'+data[x].mdSalesmancode+' '+data[x].Salesman+'</option>');
              }
                $('#salesmanList').multiselect({
                  numberDisplayed: 1,
                  enableCaseInsensitiveFiltering: true,
                  includeSelectAllOption: true,
                  selectAllNumber: true,
                  buttonWidth: '100%',
                  maxHeight: 300

                });
            }//success here;
        })
    }

    $('#salesmanList').on('change', function() {
      // alert( this.value );
      allcustomer(this.value);
    });

    
    function allcustomer(){
      var mdCode = $('#salesmanList').val();
      $.ajax ({
            url: "/nestle/connectionString/applicationipAPI.php", 
            type: "GET",
            data: {
                    "type":"CUSTOMER_LIST_AIO",
                    "CONN":con_info,
                    "mdCode":mdCode
                  },
            dataType: "html",
            crossDomain: true,
            cache: false,            
            success: function(response){                  
              var data = JSON.parse(response);
              for(var x = 0; x<data.length; x++){
                $('#customerListSelect').append('<option value="'+data[x].custCode+'">'+data[x].custCode+' '+data[x].custName+'</option>');
              }
                $('#customerListSelect').multiselect({
                  numberDisplayed: 1,
                  enableCaseInsensitiveFiltering: true,
                  includeSelectAllOption: true,
                  selectAllNumber: true,
                  buttonWidth: '100%',
                  maxHeight: 300

                });
            }//success here;
        });
      
    }

    function resend_transaction(){
      var mdCode = $('#salesman_res').val();
        var storeID = $('#storeID_res').val();
        var custCode = $('#customer_res').val();
        var refNo = $('#refno_res').val();

        var f = confirm('Are you sure you want to resend this transaction?');
        if(f){
            $.ajax({        
                url: "/nestle/connectionString/applicationipAPI.php", 
                type: "GET",
                data: {
                            "type":"get_aio_transactionID",
                            "CONN":con_info,
                            "storeID":storeID
                        },
                dataType: "html",
                crossDomain: true,
                cache: false,            
                async: false,
                success : function(r) {
                    var transactionID = r.replace(/\s/g,'');
                    resend_linking_aio_transaction(mdCode, transactionID, storeID, custCode, refNo);
                    // alert('Transaction has been verified.');
                }
            });
        }
    }

    function resend_linking_aio_transaction(mdCode, transactionID, storeID, custCode, refNo){
      console.log('transactionID:' + transactionID);
        $.ajax({        
                url: "/nestle/connectionString/applicationipAPI.php", 
                type: "GET",
                data: {
                        "type":"UPDATE_LINKING_AIOTRANSACTION", 
                        "CONN":con_info,
                        'mdCode':mdCode,
                        'storeID':storeID,
                        'transactionID':transactionID,
                        'custCode':custCode
                    },
                dataType: "html",
                crossDomain: true,
                cache: false,        
                async: false,    
                success : function(r) {
                    pushnotif(transactionID, mdCode, custCode);
                    //pushnotifAIOcustomer(refNo, mdCode);
                    alert('Transaction has been resend.');
                }
            });
    }
       
    function exec_asignSalesman(){
        var mdCode = $('#salesmanList').val();
        var storeID = $('#storeIDHolder').val();
        var custCode = $('#customerListSelect').val();
        var refNo = $('#refNo_aio').val();

        var f = confirm('Are you sure you want to continue?');
        if(f){
            $.ajax({        
                url: "/nestle/connectionString/applicationipAPI.php", 
                type: "GET",
                data: {
                            "type":"get_aio_transactionID",
                            "CONN":con_info,
                            "storeID":storeID
                        },
                dataType: "html",
                crossDomain: true,
                cache: false,            
                async: false,
                success : function(r) {
                    var transactionID = r.replace(/\s/g,'');
                    update_linking_aio_transaction(mdCode, transactionID, storeID, custCode, refNo);
                    // alert('Transaction has been verified.');
                }
            });
        }
        // pushnotif(transactionID, mdCode);
    }

    function update_linking_aio_transaction(mdCode, transactionID, storeID, custCode, refNo){
      console.log('transactionID:' + transactionID);
        $.ajax({        
                url: "/nestle/connectionString/applicationipAPI.php", 
                type: "GET",
                data: {
                        "type":"UPDATE_LINKING_AIOTRANSACTION", 
                        "CONN":con_info,
                        'mdCode':mdCode,
                        'storeID':storeID,
                        'transactionID':transactionID,
                        'custCode':custCode
                    },
                dataType: "html",
                crossDomain: true,
                cache: false,        
                async: false,    
                success : function(r) {
                    pushnotif(transactionID, mdCode, custCode);
                    pushnotifAIOcustomer(refNo, mdCode);
                    alert('Transaction has been verified.');
                }
            });
    }

    function pushnotif(transactionID, mdCode, custCode){
        var token = getToken(mdCode);
        var customername = getCustomerName(custCode);
        var header = 'Order Request';
        var message = 'Fastsosyo Order from: ' + customername;
        alert(message);
    
            $.ajax({        
            type : 'POST',
            url : "https://fcm.googleapis.com/fcm/send",
            headers : {
                Authorization : 'key=' + 
                'AAAA4OmJn2o:APA91bGBe9aHcLoJxAkkJbwN9ozac6St2BimIOVtWtb7dv-GV50v2S5-vIQzS_bZfxgl9385wyBeW4qA2GOR-BfnBV63mOHFDKMEfgZn9PNM-EAbvBtKFPEYszCLZ0OxZZPPvjyfqQMD'
                //sir roy api 'AAAA6gFzY08:APA91bGhXSORj4yKI5GDwvYIsIRCqJJn2UwO7dz_l5ZFjGmUsMj2-zpOu9R1RA7QSh0ECQ_zRibaoDLv1Z5fzk3LXqqUuaKlKJ_18ba822I4iHpgVtjSdMGdLaB37IPoGt2zFmx9Kmfy'
            },
            contentType : 'application/json',
            dataType: 'json',
            data: JSON.stringify({"to": token,
                "data": {
                        "title": header,
                        "body": message,
                        "transactionID":transactionID,
                        "click_action":"FLUTTER_NOTIFICATION_CLICK",
                        "index":"3"
                    }
                }),
            //change "to" parameter located in tblUser column TOKEN
            success : function(response) {
              console.log(response);
            },
            error : function(xhr, status, error) {
                console.log(xhr.error);                   
            }
        });
    }

    function sendSMS(message, phoneNumber){
      $.ajax ({
        url: "/nestle/connectionString/applicationipAPI.php", 
        type: "GET",
        data: {
            "type": "AIO_BROADCAST_SIRROY",
            "CONN":con_info,
            "phoneNumber" : phoneNumber,
            "message" : message,
            "smstype":"ORDER_CONFIRMATION"
          },
        crossDomain: true,
        cache: false
      });
    }

    //pushnotifAIOcustomer('2-321312', '999-test');
    function pushnotifAIOcustomer(refno, mdCode){
      var storeID = $('#storeIDHolder').val();
      var tokenCustomer = getAioStoreToken(storeID);
      console.log(tokenCustomer);

      var storenumber = $('#storecontno_aio').val();

      var salesmanObj = getSalesmanDetails(mdCode);
      var salesman = salesmanObj[0].Salesman;
      var phonenumber = salesmanObj[0].phonenumber;
      

      var message = 'Order# '+refno+' is now processed; our sales representative '+salesman+' will be reaching you anytime soon.\n\n'+
      'You may reach him at '+phonenumber+' for some clarifications. Thank you!';

      var sms_message = 'Order# '+refno+' is now processed; our sales representative '+salesman+' will be reaching you anytime soon.\n\n'+
      'You may reach him at '+phonenumber+' for some clarifications. Thank you!\n\n-FASTSOSYO';

      sendSMS(sms_message, storenumber);

    
      var header = 'Order Status';

      $.ajax({        
        type : 'POST',
        url : "https://fcm.googleapis.com/fcm/send",
        headers : {
          Authorization : 'key='+
          'AAAAAd0KUZg:APA91bG2txpQ42o-x0Hk13eBhL1iEYU_cZh6CDydc44i1ULgkvuasIgrFnaS0E65AtbWRqDGXehOQl3v3NFHN5F4h8gl8VvHdcKu_hjfyRmQvTjhiApP4r5Lw9-Pa9EAFILwWSsczyzu'
          //'AAAAl6T0xOs:APA91bF0EvvM36u1T3vuz4hTl8ZY24IrnIKgktQsCidLjsZcw7Y1SXCKUCdiFtrV__h7371pox8u4hTjWJRlJeRQhPeEAHbGURDekudXaszhNW6SwyCnhAF4a90JUebE9eXaUf7T3Vxk'
        },
        
        contentType : 'application/json',
        dataType: 'json',
        data: JSON.stringify({
          //"to": "eYAoHZHHT5qqMwY6NRXUFo:APA91bFI6oPFuBvUTdFzcyJ0-oDL7zRMe1TFvg8rekEn1N_MV5t5tIXn3hSRhgMob1ngxzp1s93ZdbWNs-jdseuJxBh-F3DDqPm5czY54uBCcm17lnq_gF4BSby4ZQcYIVgRetFsdDck",
          "to":tokenCustomer,
          "notification": {
            "title": header,
            "body": message
          },
          "data": {
                "title": header,
                "body": message
              }
          }),
        //change "to" parameter located in tblUser column TOKEN
        success : function(response) {
          console.log('customer');
          console.log(response);
        },
        error : function(xhr, status, error) {
          console.log(xhr.error);        
          alert('Message was not sent!');        
        }
      });
    }

       
</script>

     
</body>
</html> 
