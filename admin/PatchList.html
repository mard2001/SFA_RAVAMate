<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>PatchList</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.7.0/css/all.css">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css">
    <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/v/bs4/dt-1.10.18/datatables.min.css"/>
    <link rel="shortcut icon" href="/img/mdlogo_web.png" type="image/png">
</head>
<style>
    @import "https://fonts.googleapis.com/css?family=Poppins:300,400,500,600,700";
    body {
        font-family: 'Poppins', sans-serif !important;
    }
</style>
<body>

    <div class="container" style="margin-top: 20px;">
        <table id="patchList" class="table table-hover table-striped patchList" style="width:100%;">
            <thead class="thead-dark">
                <tr>
                    <th>AppName</th>
                    <th>PatchID</th>
                    <th>Notes</th>
                    <th>SP Reference</th>
                    <!--<th>Query</th>-->
                    <th>Status</th>
                    <th>Last Updated</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>

    <div class="modal fade" id="newPatchModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg" role="document">
            <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="dynamicHeader"><i class="fas fa-server"></i> NEW PATCH</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="formGroupExampleInput">Patch Note</label>
                    <input type="text" class="form-control" id="plNotesH" placeholder="">
                </div>
                <div class="form-group">
                    <label for="formGroupExampleInput">Query</label>
                    <textarea id="plQueryH" class="form-control"></textarea>
                </div>
                <div class="form-group">
                    <label for="formGroupExampleInput">Principal</label>
                    <select name="" id="p_prinsipal" class="form-control">
                        <option value="" selected disabled hidden>Choose here..</option>
                        <option value="MYBUDDY">NPI - MYBUDDY</option>
                        <option value="SHELLDATU">SPC - SHELL DATU</option>
                        <option value="MONDE">MNC - MONDE</option>
                    </select>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" onclick="insertPatch()">Insert</button>
            </div>
            </div>
        </div>
    </div>



    <div class="modal fade" id="filterpatch" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="dynamicHeader"><i class="fas fa-server"></i> Filter PATCH</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="formGroupExampleInput">Principal</label>
                    <select name="" id="p_prinsipal_filter" class="form-control">
                        <option value="" selected disabled hidden>Choose here..</option>
                        <option value="MYBUDDY">NPI - MYBUDDY</option>
                        <option value="SHELLDATU">SPC - SHELL DATU</option>
                        <option value="MONDE">MNC - MONDE</option>
                    </select>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" onclick="patchList()">Filter</button>
            </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="updatePatchModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-lg" role="document">
                <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="dynamicHeader"><i class="fas fa-server"></i> UPDATE PATCH</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <table class="table table-striped">
                        <tr>
                            <td><strong>PATCH ID</strong></td>
                            <td id="patchU"></td>
                        </tr>
                        <tr>
                            <td><strong>LAST UPDATED</strong></td>
                            <td id="lastUpdatedU"></td>
                        </tr>
                        <tr>
                            <td><strong>NOTE</strong></td>
                            <td>
                                <input type="text" class="form-control" id="noteU"></input>
                            </td>
                        </tr>
                        <tr>
                            <td><strong>QUERY</strong></td>
                            <td>
                                <textarea id="queryU" class="form-control"></textarea>
                            </td>
                        </tr>
                        <tr>
                            <td><strong>STATUS</strong></td>
                            <td>
                                <select class="form-control" id="statusU">
                                    <option value="0" class="text-success">ENABLED</option>
                                    <option value="1" class="text-danger">DISABLED</option>
                                </select>
                            </td>
                        </tr>
                    </table>
                    <input type="hidden" id="patchIdUpdateHolder"></input>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-warning" onclick="updatePatch()">Update</button>
                    <button type="button" class="btn btn-danger" onclick="deletePatch()"><i class="fas fa-trash"></i> Remove</button>
                </div>
                </div>
            </div>
        </div>
    
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js"></script>
    
    <script type="text/javascript" src="https://cdn.datatables.net/v/bs4/dt-1.10.18/datatables.min.js"></script>
    <script type="text/javascript" src="https://cdn.datatables.net/responsive/2.2.3/js/dataTables.responsive.min.js"></script>
    <script type="text/javascript" src="https://cdn.datatables.net/responsive/2.2.3/js/responsive.bootstrap4.min.js"></script> 
    <script type="text/javascript" src="https://cdn.datatables.net/buttons/1.3.1/js/dataTables.buttons.min.js"></script>
    <script type="text/javascript" src="js/notfunction.js"></script>
    <script type="text/javascript" src="/js/scrolling.js"></script>
    <script type="text/javascript">
    var GLOBALLINKAPI = 'https://fast-onesolutions.com/BUDDYGBLAPI/';
    function updatePatch(){
        var patchID = $('#patchIdUpdateHolder').val(); 
        var note = $('#noteU').val(); 
        var query = $('#queryU').val();
        var status = $('#statusU').val(); 

        var f = confirm('Are you sure you want to update this patch?');
        if(f){
            $.ajax ({
                url: GLOBALLINKAPI+"/admin/connection/applicationApi.php",
                type: "post",
                data: {
                    "type":"UPDATE_PATCH",
                    "patchID":patchID,
                    "notes":note,
                    "query":query,
                    "status":status
                },
                dataType: "json",
                crossDomain: true,
                cache: false,  
                async: false,          
                success: function(r){
                    if(r){
                        patchList();
                        tableData.clear().rows.add(pl_source).draw();
                        alert('Patch successfully updated!');
                        $('textarea#plQueryH').val('');
                        $('#plNotesH').val('');
                        $('#updatePatchModal').modal('hide');
                    }
                }
            });
        }
    }

    function deletePatch(){
        var f = confirm('Are you sure you want to delete this patch?');
        if(f){
            var patchID = $('#patchIdUpdateHolder').val(); 
            $.ajax ({
                url: GLOBALLINKAPI+"/admin/connection/applicationApi.php",
                type: "GET",
                data: {
                    "type":"DELETE_PATCH",
                    "patchID":patchID
                },
                dataType: "json",
                crossDomain: true,
                cache: false,  
                async: false,          
                success: function(r){
                    if(r){
                        patchList();
                        tableData.clear().rows.add(pl_source).draw();
                        alert('Patch successfully deleted!');
                        $('textarea#plQueryH').val('');
                        $('#plNotesH').val('');
                        $('#updatePatchModal').modal('hide');
                    }
                }
            });
        }
    }

    function insertPatch(){
        var query = $('textarea#plQueryH').val();
        var notes = $('#plNotesH').val();
        var principal = $('#p_prinsipal').val();

        if(query == '' || notes == ''){
            alert('Empty fields are not accepted!');
        }else if(principal == undefined){
            alert('Please select principal.');
        }else{
            $.ajax ({
                url: GLOBALLINKAPI+"/admin/connection/applicationApi.php",
                type: "POST",
                data: {
                    "type":"INSERT_PATCH",
                    "notes":notes,
                    "query":query,
                    "principal":principal
                },
                dataType: "json",
                crossDomain: true,
                cache: false,  
                async: false,          
                success: function(r){
                    if(r){
                        patchList();
                        tableData.clear().rows.add(pl_source).draw();
                        alert('Patch successfully inserted!');
                        $('textarea#plQueryH').val('');
                        $('#plNotesH').val('');

                        $('#p_prinsipal').val('').change();
                        $('#newPatchModal').modal('hide');
                    }
                }
            });
        }
    } 
     

    
    function patchList(){
        var principal = $('#p_prinsipal_filter').val();

      //  if(principal == undefined){
        //    alert('Please select a principal');
        //}else{
            $.ajax ({
                url: GLOBALLINKAPI+"/admin/connection/applicationApi.php",
                type: "GET",
                data: {
                    "type":"PATCH_LIST",
                    appName:principal
                },
                dataType: "json",
                crossDomain: true,
                cache: false,  
                async: false,          
                    success: function(r){
                        pl_source = r;
                        tableData.clear().rows.add(r).draw();   

                        $('#filterpatch').modal('hide');

                    }
            });   
       // }
       
    } 
    
    // patchList();
    var tableDatam, pl_source;
    patchListTable();
    function patchListTable(){
        tableData = $('table.patchList').DataTable({
            "dom": 'Bfrtip',
            "responsive": true,
            "data": pl_source,
            "scrollX": true,
            // width: 100%,
            "ordering": true,
            "order": [[ 5, "desc" ]],
            "pageLength": 10,
            language: {
                select: {
                    rows: ""
                }
            },
            columns: [
                { data: "AppName"},
                { data: "patchLevel"},
                { data: "PLNotes"},
                { data: "PLReference"},
                //{ data: "PLQuery"},
                { data: "PLStatus" },
                { data: "lastUpdated" }
            ],
            buttons: [
                {
                    text: '<i class="fas fa-plus-circle"></i> NEW PATCH',
                    className: 'btn btn-primary btn-sm',
                    action: function(e, dt, node, config){
        
                        $('#plNotesH').val('').change();
                        $('#plQueryH').val('').change();
                        $('#p_prinsipal').val('').change();
                        $('#newPatchModal').modal({
                            backdrop: 'static',
                            keyboard: false
                        });
                    }
                },
                {
                    text: 'FILTER PATCH',
                    className: 'btn btn-secondary btn-sm',
                    action: function(e, dt, node, config){
                    
                        $('#p_prinsipal_filter').val('').change();
                        $('#filterpatch').modal({
                            backdrop: 'static',
                            keyboard: false
                        });
                    }
                },
                {
                    text: '<i class="fas fa-map-pin"></i> FAKE GPS TAGGING',
                    className: 'btn btn-warning btn-sm',
                    action: function(e, dt, node, config){
                        var win = window.open('fakeGPSTagging', '_blank');
                        if (win) {
                            //Browser has allowed it to be opened
                            win.focus();
                        } else {
                            //Browser has blocked it
                            alert('Please allow popups for this website');
                        }
                    }
                }
            ],
            rowCallback: function(row, data, index){
                if(data.PLStatus.toString() == '0'){
                    $(row).find('td:eq(4)').css({'color':'green', 'letter-spacing':'3px', 'font-size':'12px'});
                    $(row).find('td:eq(4)').text('enabled');
                }else{
                    $(row).find('td:eq(4)').css({'color':'red', 'letter-spacing':'3px', 'font-size':'12px'});
                    $(row).find('td:eq(4)').text('disabled');
                }
            },
        });
          
	    $('table.patchList tbody').on('click', 'tr', function () {
            var tr = $(this).closest('tr');
            var row = tableData.row(tr);
            //showsvr(row.data());
            setPatchdata_update(row.data());
        });
        
        function setPatchdata_update(r){
            get_query_details(r.cID);
            $('#patchU').html(r.patchLevel); 
            $('#lastUpdatedU').html(r.lastUpdated);
            $('#patchIdUpdateHolder').val(r.patchLevel); 
            $('#noteU').val(r.PLNotes); 
            // $('#queryU').val(r.PLQuery);
            $('#statusU').val(r.PLStatus); 
            $('#updatePatchModal').modal('show');
               
        }

        function get_query_details(cID){
            $.ajax ({
                url: GLOBALLINKAPI+"/admin/connection/applicationApi.php",
                type: "GET",
                data: {
                    "type":"PATCH_LIST_DETAILS",
                    patchID:cID
                },
                dataType: "json",
                crossDomain: true,
                cache: false,  
                async: false,          
                success: function(r){
                    $('#queryU').val(r[0].PLQuery);
                    // console.log(r[0].PLQuery);
                }
            });   
        } 
    }
    </script>
</body>
</html>